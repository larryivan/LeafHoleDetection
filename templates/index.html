<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="title">Leaf Hole Detection System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: #f5f5f5;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .header {
            background: white;
            border-bottom: 1px solid #e0e0e0;
            padding: 1rem 0;
            margin-bottom: 2rem;
        }
        
        .container {
            max-width: 1200px;
        }
        
        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            background: white;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .upload-area:hover {
            border-color: #007bff;
            background: #f8f9fa;
        }
        
        .upload-area.dragover {
            border-color: #007bff;
            background: #e3f2fd;
        }
        
        .mode-switch {
            background: white;
            border-radius: 8px;
            padding: 0.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid #e0e0e0;
        }
        
        .card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .stat-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        
        .stat-label {
            font-size: 0.875rem;
            color: #666;
        }
        
        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .image-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .image-card img {
            width: 100%;
            height: auto;
        }
        
        .image-card .card-body {
            padding: 0.75rem;
        }
        
        .batch-item {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 1rem;
            overflow: hidden;
        }
        
        .batch-header {
            background: #f8f9fa;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .batch-content {
            padding: 1rem;
        }
        
        .btn-group .btn {
            border-radius: 6px;
        }
        
        .processing {
            background: white;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            margin: 2rem 0;
        }
        
        .hidden { display: none !important; }
        
        .canvas-container {
            border: 2px solid #ddd;
            border-radius: 8px;
            display: inline-block;
            background: #f9f9f9;
        }
        
        .edit-canvas {
            display: block;
            max-width: 100%;
            cursor: crosshair;
        }
        
        .toolbar {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .collapse-btn {
            background: none;
            border: none;
            color: #007bff;
            padding: 0;
            margin-left: auto;
        }
        
        .footer {
            background: white;
            border-top: 1px solid #e0e0e0;
            padding: 2rem 0;
            margin-top: 3rem;
            text-align: center;
            color: #666;
            font-size: 0.875rem;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col">
                    <h1 class="h4 mb-0" data-i18n="title">å¶ç‰‡è™«æ´æ£€æµ‹ç³»ç»Ÿ</h1>
                    <small class="text-muted" data-i18n="subtitle">åŸºäºAIçš„å¶ç‰‡åˆ†æä¸æ‰‹åŠ¨ç¼–è¾‘</small>
                </div>
                <div class="col-auto">
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-secondary" onclick="setLanguage('zh')">ä¸­æ–‡</button>
                        <button class="btn btn-outline-secondary" onclick="setLanguage('en')">EN</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Mode Selection -->
        <div class="mode-switch">
            <div class="btn-group w-100" role="group">
                <input type="radio" class="btn-check" name="mode" id="singleMode" checked>
                <label class="btn btn-outline-primary" for="singleMode" onclick="setMode('single')">
                    <i class="fas fa-image me-2"></i><span data-i18n="singleMode">å•å¼ å›¾åƒ</span>
                </label>
                <input type="radio" class="btn-check" name="mode" id="batchMode">
                <label class="btn btn-outline-primary" for="batchMode" onclick="setMode('batch')">
                    <i class="fas fa-images me-2"></i><span data-i18n="batchMode">æ‰¹é‡å¤„ç†</span>
                </label>
            </div>
        </div>

        <!-- Upload Areas -->
        <div id="singleUploadArea" class="upload-area">
            <i class="fas fa-cloud-upload-alt fa-2x text-muted mb-3"></i>
            <h5 data-i18n="uploadTitle">æ‹–æ‹½å¶ç‰‡å›¾åƒåˆ°æ­¤å¤„</h5>
            <p class="text-muted mb-3" data-i18n="uploadSubtitle">æˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</p>
            <button type="button" class="btn btn-primary">
                <span data-i18n="chooseFile">é€‰æ‹©æ–‡ä»¶</span>
            </button>
            <div class="mt-2">
                <small class="text-muted" data-i18n="uploadInfo">æ”¯æŒæ ¼å¼ï¼šPNG, JPG, JPEG, GIF, BMP (æœ€å¤§16MB)</small><br>
                <small class="text-info" data-i18n="referenceInfo">ğŸ’¡ åŒ…å«1cmÃ—1cmå‚ç…§æ–¹å—å¯è·å¾—ç»å¯¹é¢ç§¯æµ‹é‡</small>
            </div>
        </div>

        <div id="batchUploadArea" class="upload-area hidden">
            <i class="fas fa-images fa-2x text-muted mb-3"></i>
            <h5 data-i18n="batchUploadTitle">æ‹–æ‹½å¤šå¼ å¶ç‰‡å›¾åƒåˆ°æ­¤å¤„</h5>
            <p class="text-muted mb-3" data-i18n="batchUploadSubtitle">æˆ–ç‚¹å‡»é€‰æ‹©å¤šä¸ªæ–‡ä»¶</p>
            <button type="button" class="btn btn-primary">
                <span data-i18n="chooseFiles">é€‰æ‹©æ–‡ä»¶</span>
            </button>
            <div class="mt-2">
                <small class="text-muted" data-i18n="uploadInfo">æ”¯æŒæ ¼å¼ï¼šPNG, JPG, JPEG, GIF, BMP (æœ€å¤§16MB)</small><br>
                <small class="text-info" data-i18n="referenceInfo">ğŸ’¡ åŒ…å«1cmÃ—1cmå‚ç…§æ–¹å—å¯è·å¾—ç»å¯¹é¢ç§¯æµ‹é‡</small>
            </div>
        </div>

        <!-- Processing Indicator -->
        <div id="processingSection" class="processing hidden">
            <div class="spinner-border text-primary mb-3" role="status"></div>
            <h5 data-i18n="processing">æ­£åœ¨å¤„ç†å›¾åƒ...</h5>
            <p class="text-muted" data-i18n="processingSubtitle">AIæ­£åœ¨åˆ†ææ‚¨çš„å¶ç‰‡å›¾åƒ</p>
        </div>

        <!-- Single Image Results -->
        <div id="singleResults" class="hidden">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0" data-i18n="resultsTitle">æ£€æµ‹ç»“æœ</h5>
                </div>
                <div class="card-body">
                    <!-- Statistics -->
                    <div class="stats-grid" id="statsGrid">
                        <div class="stat-card">
                            <div class="stat-value text-primary" id="holeRatio">-</div>
                            <div class="stat-label" data-i18n="holeRatio">è™«æ´å æ¯”</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value text-success" id="leafArea">-</div>
                            <div class="stat-label" data-i18n="leafArea">å¶ç‰‡é¢ç§¯</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value text-danger" id="holeArea">-</div>
                            <div class="stat-label" data-i18n="holeArea">è™«æ´é¢ç§¯</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value text-warning" id="holeCount">-</div>
                            <div class="stat-label" data-i18n="holeCount">è™«æ´æ•°é‡</div>
                        </div>
                        <div class="stat-card hidden" id="leafAreaCm2Card">
                            <div class="stat-value text-success" id="leafAreaCm2">-</div>
                            <div class="stat-label" data-i18n="leafAreaCm2">å¶ç‰‡é¢ç§¯ (cmÂ²)</div>
                        </div>
                        <div class="stat-card hidden" id="holeAreaCm2Card">
                            <div class="stat-value text-danger" id="holeAreaCm2">-</div>
                            <div class="stat-label" data-i18n="holeAreaCm2">è™«æ´é¢ç§¯ (cmÂ²)</div>
                        </div>
                        <div class="stat-card" id="leafLengthCard">
                            <div class="stat-value text-info" id="leafLength">-</div>
                            <div class="stat-label" data-i18n="leafLength">å¶ç‰‡é•¿åº¦</div>
                        </div>
                        <div class="stat-card" id="leafWidthCard">
                            <div class="stat-value text-info" id="leafWidth">-</div>
                            <div class="stat-label" data-i18n="leafWidth">å¶ç‰‡å®½åº¦</div>
                        </div>
                        <div class="stat-card hidden" id="leafLengthCmCard">
                            <div class="stat-value text-info" id="leafLengthCm">-</div>
                            <div class="stat-label" data-i18n="leafLengthCm">å¶ç‰‡é•¿åº¦ (cm)</div>
                        </div>
                        <div class="stat-card hidden" id="leafWidthCmCard">
                            <div class="stat-value text-info" id="leafWidthCm">-</div>
                            <div class="stat-label" data-i18n="leafWidthCm">å¶ç‰‡å®½åº¦ (cm)</div>
                        </div>
                    </div>

                    <!-- Reference Info -->
                    <div id="referenceInfo" class="alert alert-info hidden">
                        <i class="fas fa-ruler me-2"></i>
                        <span data-i18n="referenceDetected">æ£€æµ‹åˆ°å‚ç…§æ–¹å—</span>
                        - <span id="pixelsPerCm">-</span> <span data-i18n="pixelsPerCm">åƒç´ æ¯å˜ç±³</span>
                    </div>

                    <!-- Action Buttons -->
                    <div class="text-center mb-3">
                        <button class="btn btn-warning me-2" onclick="showManualEdit()">
                            <i class="fas fa-edit me-2"></i><span data-i18n="manualEdit">æ‰‹åŠ¨ç¼–è¾‘</span>
                        </button>
                        <button class="btn btn-secondary" onclick="resetApp()">
                            <i class="fas fa-redo me-2"></i><span data-i18n="newAnalysis">é‡æ–°åˆ†æ</span>
                        </button>
                    </div>

                    <!-- Images -->
                    <div class="image-grid">
                        <div class="image-card">
                            <img id="originalImage" src="" alt="Original">
                            <div class="card-body">
                                <h6 class="card-title" data-i18n="originalImage">åŸå§‹å›¾åƒ</h6>
                            </div>
                        </div>
                        <div class="image-card">
                            <img id="enhancedImage" src="" alt="Enhanced">
                            <div class="card-body">
                                <h6 class="card-title" data-i18n="enhancedImage">å¢å¼ºå›¾åƒ</h6>
                            </div>
                        </div>
                        <div class="image-card">
                            <img id="leafMask" src="" alt="Leaf Mask">
                            <div class="card-body">
                                <h6 class="card-title" data-i18n="leafSegmentation">å¶ç‰‡åˆ†å‰²</h6>
                            </div>
                        </div>
                        <div class="image-card">
                            <img id="holesImage" src="" alt="Holes">
                            <div class="card-body">
                                <h6 class="card-title" data-i18n="detectedHoles">æ£€æµ‹åˆ°çš„è™«æ´</h6>
                            </div>
                        </div>
                        <div class="image-card">
                            <img id="resultImage" src="" alt="Result">
                            <div class="card-body">
                                <h6 class="card-title" data-i18n="finalResult">æœ€ç»ˆç»“æœ</h6>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Batch Results -->
        <div id="batchResults" class="hidden">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0" data-i18n="batchResultsTitle">æ‰¹é‡å¤„ç†ç»“æœ</h5>
                    <button class="btn btn-success btn-sm" onclick="exportBatchResults()">
                        <i class="fas fa-download me-2"></i><span data-i18n="exportResults">å¯¼å‡ºç»“æœ</span>
                    </button>
                </div>
                <div class="card-body">
                    <!-- Summary Stats -->
                    <div class="stats-grid" id="batchStatsGrid">
                        <div class="stat-card">
                            <div class="stat-value text-primary" id="totalFiles">-</div>
                            <div class="stat-label" data-i18n="totalFiles">æ€»æ–‡ä»¶æ•°</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value text-success" id="successfulFiles">-</div>
                            <div class="stat-label" data-i18n="successfulFiles">æˆåŠŸå¤„ç†</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value text-warning" id="avgHoleRatio">-</div>
                            <div class="stat-label" data-i18n="avgHoleRatio">å¹³å‡è™«æ´å æ¯”</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value text-info" id="filesWithReference">-</div>
                            <div class="stat-label" data-i18n="filesWithReference">å«å‚ç…§æ–¹å—</div>
                        </div>
                    </div>

                    <!-- Absolute Area Summary -->
                    <div id="absoluteAreaSummary" class="stats-grid hidden">
                        <div class="stat-card">
                            <div class="stat-value text-success" id="totalLeafAreaCm2">-</div>
                            <div class="stat-label" data-i18n="totalLeafAreaCm2">æ€»å¶ç‰‡é¢ç§¯ (cmÂ²)</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value text-danger" id="totalHoleAreaCm2">-</div>
                            <div class="stat-label" data-i18n="totalHoleAreaCm2">æ€»è™«æ´é¢ç§¯ (cmÂ²)</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value text-primary" id="overallHoleRatioCm2">-</div>
                            <div class="stat-label" data-i18n="overallHoleRatioCm2">æ€»ä½“è™«æ´å æ¯”</div>
                        </div>
                    </div>

                    <!-- Individual Results -->
                    <div id="batchItemsContainer"></div>
                </div>
            </div>
        </div>

        <!-- Manual Edit Modal -->
        <div id="manualEditModal" class="hidden">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0" data-i18n="manualEditTitle">æ‰‹åŠ¨ç¼–è¾‘æ¨¡å¼</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted" data-i18n="manualEditDesc">ç‚¹å‡»å¹¶æ‹–æ‹½é€‰æ‹©å¶ç‰‡åŒºåŸŸæˆ–è™«æ´ã€‚ä½¿ç”¨ä¸‹æ–¹å·¥å…·åˆ‡æ¢æ¨¡å¼ã€‚</p>
                    
                    <div class="toolbar">
                        <div class="btn-group me-3">
                            <button class="btn btn-outline-success active" id="leafTool" onclick="setTool('leaf')">
                                <span data-i18n="selectLeafArea">é€‰æ‹©å¶ç‰‡åŒºåŸŸ</span>
                            </button>
                            <button class="btn btn-outline-danger" id="holeTool" onclick="setTool('hole')">
                                <span data-i18n="markHoles">æ ‡è®°è™«æ´</span>
                            </button>
                        </div>
                        <button class="btn btn-outline-secondary me-2" onclick="clearCanvas()">
                            <span data-i18n="clearAll">æ¸…é™¤å…¨éƒ¨</span>
                        </button>
                        <button class="btn btn-primary me-2" onclick="recalculate()">
                            <span data-i18n="recalculate">é‡æ–°è®¡ç®—</span>
                        </button>
                        <button class="btn btn-secondary" onclick="hideManualEdit()">
                            <span data-i18n="cancel">å–æ¶ˆ</span>
                        </button>
                    </div>
                    
                    <div class="text-center">
                        <div class="canvas-container">
                            <canvas id="editCanvas" class="edit-canvas"></canvas>
                        </div>
                    </div>
                    
                    <div class="mt-2 text-center">
                        <small class="text-muted" data-i18n="canvasInfo">å·¦é”®ç‚¹å‡»å¹¶æ‹–æ‹½ç»˜åˆ¶é€‰æ‹©åŒºåŸŸã€‚åˆ‡æ¢å·¥å…·æ ‡è®°ä¸åŒåŒºåŸŸã€‚</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="footer">
        <div class="container">
            <span data-i18n="developer">å¼€å‘è€…</span> <strong>Larry Ivan Han</strong><br>
            <span data-i18n="contact">è”ç³»æ–¹å¼ï¼š</span> <a href="mailto:larryivanhan@gmail.com">larryivanhan@gmail.com</a>
        </div>
    </div>

    <!-- Hidden file inputs -->
    <input type="file" id="fileInput" accept="image/*" style="display: none;">
    <input type="file" id="batchFileInput" accept="image/*" multiple style="display: none;">

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/i18n.js') }}"></script>
    <script>
        let currentTool = 'leaf';
        let canvas, ctx;
        let isDrawing = false;
        let leafSelections = [];
        let holeSelections = [];
        let currentImage = null;
        let currentMode = 'single';
        let batchResults = null;
        let currentEditingItem = null;

        const singleUploadArea = document.getElementById('singleUploadArea');
        const batchUploadArea = document.getElementById('batchUploadArea');
        const fileInput = document.getElementById('fileInput');
        const batchFileInput = document.getElementById('batchFileInput');
        const processingSection = document.getElementById('processingSection');
        const resultsSection = document.getElementById('singleResults');
        const batchResultsSection = document.getElementById('batchResults');

        // Mode switching
        function setMode(mode) {
            currentMode = mode;
            resetApp();
            if (mode === 'single') {
                singleUploadArea.classList.remove('hidden');
                batchUploadArea.classList.add('hidden');
            } else {
                singleUploadArea.classList.add('hidden');
                batchUploadArea.classList.remove('hidden');
            }
        }

        // Language switching
        function setLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('language', lang);
            updateLanguage();
        }

        function updateLanguage() {
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                element.textContent = t(key);
            });
        }

        // Initialize event listeners
        function initEventListeners() {
            // Single file upload
            singleUploadArea.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                fileInput.click();
            });
            
            singleUploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
                singleUploadArea.classList.add('dragover');
            });
            
            singleUploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                e.stopPropagation();
                singleUploadArea.classList.remove('dragover');
            });
            
            singleUploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();
                singleUploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    processFile(files[0]);
                }
            });

            // Batch files upload
            batchUploadArea.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                batchFileInput.click();
            });
            
            batchUploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
                batchUploadArea.classList.add('dragover');
            });
            
            batchUploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                e.stopPropagation();
                batchUploadArea.classList.remove('dragover');
            });
            
            batchUploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();
                batchUploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    processBatchFiles(files);
                }
            });

            // File input changes
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    processFile(e.target.files[0]);
                }
            });

            batchFileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    processBatchFiles(e.target.files);
                }
            });
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            initEventListeners();
            updateLanguage();
        });

        function processFile(file) {
            if (!file.type.startsWith('image/')) {
                alert(t('invalidFileError'));
                return;
            }

            if (file.size > 16 * 1024 * 1024) {
                alert(t('fileSizeError'));
                return;
            }

            processingSection.classList.remove('hidden');
            resultsSection.classList.add('hidden');
            document.getElementById('manualEditModal').classList.add('hidden');

            const formData = new FormData();
            formData.append('file', file);

            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.text();
            })
            .then(text => {
                try {
                    const data = JSON.parse(text);
                    processingSection.classList.add('hidden');
                    if (data.success) {
                        displayResults(data);
                    } else {
                        alert(t('processingError') + ': ' + data.error);
                    }
                } catch (e) {
                    console.error('JSON parse error:', e);
                    console.error('Response text:', text);
                    throw new Error('æœåŠ¡å™¨è¿”å›äº†æ— æ•ˆçš„JSONå“åº”ã€‚è¯·æ£€æŸ¥æ§åˆ¶å°äº†è§£è¯¦ç»†ä¿¡æ¯ã€‚');
                }
            })
            .catch(error => {
                processingSection.classList.add('hidden');
                alert(t('processingError') + ': ' + error.message);
            });
        }

        function displayResults(data) {
            document.getElementById('holeRatio').textContent = data.hole_ratio;
            document.getElementById('leafArea').textContent = data.statistics.leaf_area_pixels.toLocaleString();
            document.getElementById('holeArea').textContent = data.statistics.hole_area_pixels.toLocaleString();
            document.getElementById('holeCount').textContent = data.statistics.hole_count;

            // Display leaf length and width
            document.getElementById('leafLength').textContent = data.statistics.leaf_length_pixels ? data.statistics.leaf_length_pixels.toFixed(1) + ' px' : '-';
            document.getElementById('leafWidth').textContent = data.statistics.leaf_width_pixels ? data.statistics.leaf_width_pixels.toFixed(1) + ' px' : '-';

            // Show/hide absolute area columns based on reference detection
            if (data.statistics.has_reference && data.statistics.reference_detected) {
                document.getElementById('leafAreaCm2Card').classList.remove('hidden');
                document.getElementById('holeAreaCm2Card').classList.remove('hidden');
                document.getElementById('leafLengthCmCard').classList.remove('hidden');
                document.getElementById('leafWidthCmCard').classList.remove('hidden');
                document.getElementById('referenceInfo').classList.remove('hidden');
                
                document.getElementById('leafAreaCm2').textContent = data.statistics.leaf_area_cm2.toFixed(2);
                document.getElementById('holeAreaCm2').textContent = data.statistics.hole_area_cm2.toFixed(2);
                document.getElementById('leafLengthCm').textContent = data.statistics.leaf_length_cm ? data.statistics.leaf_length_cm.toFixed(2) + ' cm' : '-';
                document.getElementById('leafWidthCm').textContent = data.statistics.leaf_width_cm ? data.statistics.leaf_width_cm.toFixed(2) + ' cm' : '-';
                document.getElementById('pixelsPerCm').textContent = data.statistics.pixels_per_cm.toFixed(1);
            } else {
                document.getElementById('leafAreaCm2Card').classList.add('hidden');
                document.getElementById('holeAreaCm2Card').classList.add('hidden');
                document.getElementById('leafLengthCmCard').classList.add('hidden');
                document.getElementById('leafWidthCmCard').classList.add('hidden');
                document.getElementById('referenceInfo').classList.add('hidden');
            }

            document.getElementById('originalImage').src = data.images.original;
            document.getElementById('enhancedImage').src = data.images.enhanced;
            document.getElementById('leafMask').src = data.images.leaf_mask;
            document.getElementById('holesImage').src = data.images.holes;
            document.getElementById('resultImage').src = data.images.result;

            resultsSection.classList.remove('hidden');
        }

        function updateStatistics(stats) {
            document.getElementById('holeRatio').textContent = stats.hole_ratio;
            document.getElementById('leafArea').textContent = stats.leaf_area_pixels.toLocaleString();
            document.getElementById('holeArea').textContent = stats.hole_area_pixels.toLocaleString();
            document.getElementById('holeCount').textContent = stats.hole_count;
            
            // Update leaf length and width
            document.getElementById('leafLength').textContent = stats.leaf_length_pixels ? stats.leaf_length_pixels.toFixed(1) + ' px' : '-';
            document.getElementById('leafWidth').textContent = stats.leaf_width_pixels ? stats.leaf_width_pixels.toFixed(1) + ' px' : '-';
            
            // Update absolute areas if available
            if (stats.has_reference && stats.reference_detected) {
                document.getElementById('leafAreaCm2Card').classList.remove('hidden');
                document.getElementById('holeAreaCm2Card').classList.remove('hidden');
                document.getElementById('leafLengthCmCard').classList.remove('hidden');
                document.getElementById('leafWidthCmCard').classList.remove('hidden');
                document.getElementById('referenceInfo').classList.remove('hidden');
                
                document.getElementById('leafAreaCm2').textContent = stats.leaf_area_cm2.toFixed(2);
                document.getElementById('holeAreaCm2').textContent = stats.hole_area_cm2.toFixed(2);
                document.getElementById('leafLengthCm').textContent = stats.leaf_length_cm ? stats.leaf_length_cm.toFixed(2) + ' cm' : '-';
                document.getElementById('leafWidthCm').textContent = stats.leaf_width_cm ? stats.leaf_width_cm.toFixed(2) + ' cm' : '-';
                document.getElementById('pixelsPerCm').textContent = stats.pixels_per_cm.toFixed(1);
            } else {
                document.getElementById('leafAreaCm2Card').classList.add('hidden');
                document.getElementById('holeAreaCm2Card').classList.add('hidden');
                document.getElementById('leafLengthCmCard').classList.add('hidden');
                document.getElementById('leafWidthCmCard').classList.add('hidden');
                document.getElementById('referenceInfo').classList.add('hidden');
            }
        }

        function resetApp() {
            resultsSection.classList.add('hidden');
            processingSection.classList.add('hidden');
            batchResultsSection.classList.add('hidden');
            document.getElementById('manualEditModal').classList.add('hidden');
            fileInput.value = '';
            batchFileInput.value = '';
            batchResults = null;
        }

        function showManualEdit(itemData = null) {
            currentEditingItem = itemData;
            document.getElementById('manualEditModal').classList.remove('hidden');
            initCanvas();
        }

        function hideManualEdit() {
            document.getElementById('manualEditModal').classList.add('hidden');
            currentEditingItem = null;
        }

        function initCanvas() {
            canvas = document.getElementById('editCanvas');
            ctx = canvas.getContext('2d');
            
            const img = new Image();
            img.onload = function() {
                canvas.width = Math.min(img.width, 600);
                canvas.height = (canvas.width / img.width) * img.height;
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                currentImage = ctx.getImageData(0, 0, canvas.width, canvas.height);
            };
            
            // Get image source based on current context
            if (currentEditingItem && currentEditingItem.images) {
                img.src = currentEditingItem.images.enhanced;
            } else {
                const enhancedImg = document.getElementById('enhancedImage');
                img.src = enhancedImg ? enhancedImg.src : '';
            }
            
            // Clear existing event listeners and add new ones
            canvas.removeEventListener('mousedown', startDrawing);
            canvas.removeEventListener('mousemove', draw);
            canvas.removeEventListener('mouseup', stopDrawing);
            canvas.removeEventListener('mouseout', stopDrawing);
            
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
        }

        function setTool(tool) {
            currentTool = tool;
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tool + 'Tool').classList.add('active');
        }

        function startDrawing(e) {
            isDrawing = true;
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            if (currentTool === 'leaf') {
                leafSelections.push([{x, y}]);
            } else {
                holeSelections.push([{x, y}]);
            }
        }

        function draw(e) {
            if (!isDrawing) return;
            
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            if (currentTool === 'leaf') {
                const currentPath = leafSelections[leafSelections.length - 1];
                currentPath.push({x, y});
                redrawCanvas();
            } else {
                const currentPath = holeSelections[holeSelections.length - 1];
                currentPath.push({x, y});
                redrawCanvas();
            }
        }

        function stopDrawing() {
            isDrawing = false;
        }

        function redrawCanvas() {
            if (!currentImage) return;
            
            ctx.putImageData(currentImage, 0, 0);
            
            // Draw leaf selections in green
            ctx.strokeStyle = '#28a745';
            ctx.lineWidth = 3;
            leafSelections.forEach(path => {
                if (path.length > 1) {
                    ctx.beginPath();
                    ctx.moveTo(path[0].x, path[0].y);
                    path.forEach(point => ctx.lineTo(point.x, point.y));
                    ctx.stroke();
                }
            });
            
            // Draw hole selections in red
            ctx.strokeStyle = '#dc3545';
            ctx.lineWidth = 2;
            holeSelections.forEach(path => {
                if (path.length > 1) {
                    ctx.beginPath();
                    ctx.moveTo(path[0].x, path[0].y);
                    path.forEach(point => ctx.lineTo(point.x, point.y));
                    ctx.stroke();
                }
            });
        }

        function clearCanvas() {
            leafSelections = [];
            holeSelections = [];
            if (currentImage) {
                ctx.putImageData(currentImage, 0, 0);
            }
        }

        function recalculate() {
            const selections = {
                leaf: leafSelections,
                holes: holeSelections,
                canvasWidth: canvas.width,
                canvasHeight: canvas.height
            };
            
            fetch('/manual_edit', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(selections)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (currentEditingItem) {
                        // Update batch item statistics
                        updateBatchItemStatistics(currentEditingItem, data.statistics);
                    } else {
                        // Update single image statistics
                        updateStatistics(data.statistics);
                    }
                    hideManualEdit();
                    alert(t('recalculatedSuccess'));
                } else {
                    alert(t('processingError') + ': ' + data.error);
                }
            })
            .catch(error => {
                alert(t('processingError') + ': ' + error.message);
            });
        }

        function updateBatchItemStatistics(item, newStats) {
            // Update the item in batchResults
            const itemIndex = batchResults.results.findIndex(r => r.filename === item.filename);
            if (itemIndex !== -1) {
                batchResults.results[itemIndex].statistics = newStats;
                batchResults.results[itemIndex].hole_ratio = newStats.hole_ratio;
                
                // Refresh the batch display
                displayBatchResults(batchResults);
            }
        }

        // Batch processing functions
        function processBatchFiles(files) {
            processingSection.classList.remove('hidden');
            
            const formData = new FormData();
            for (let i = 0; i < files.length; i++) {
                formData.append('files', files[i]);
            }
            
            fetch('/batch_upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                processingSection.classList.add('hidden');
                if (data.success) {
                    batchResults = data;
                    displayBatchResults(data);
                } else {
                    alert(t('processingError') + ': ' + data.error);
                }
            })
            .catch(error => {
                processingSection.classList.add('hidden');
                alert(t('processingError') + ': ' + error.message);
            });
        }

        function displayBatchResults(data) {
            // Update summary statistics
            document.getElementById('totalFiles').textContent = data.summary.total_files;
            document.getElementById('successfulFiles').textContent = data.summary.successful_files;
            document.getElementById('avgHoleRatio').textContent = data.summary.avg_hole_ratio || '-';
            document.getElementById('filesWithReference').textContent = data.summary.files_with_reference || '0';
            
            // Show/hide absolute area summary
            if (data.summary.files_with_reference > 0) {
                document.getElementById('absoluteAreaSummary').classList.remove('hidden');
                document.getElementById('totalLeafAreaCm2').textContent = data.summary.total_leaf_area_cm2.toFixed(2);
                document.getElementById('totalHoleAreaCm2').textContent = data.summary.total_hole_area_cm2.toFixed(2);
                document.getElementById('overallHoleRatioCm2').textContent = data.summary.overall_hole_ratio_cm2;
            } else {
                document.getElementById('absoluteAreaSummary').classList.add('hidden');
            }
            
            // Populate individual results
            const container = document.getElementById('batchItemsContainer');
            container.innerHTML = '';
            
            data.results.forEach((result, index) => {
                const item = createBatchItem(result, index);
                container.appendChild(item);
            });
            
            batchResultsSection.classList.remove('hidden');
        }

        function createBatchItem(result, index) {
            const item = document.createElement('div');
            item.className = 'batch-item';
            item.innerHTML = `
                <div class="batch-header d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-0">${result.filename}</h6>
                        ${result.success ? 
                            `<span class="badge bg-success">${t('success')}</span>` : 
                            `<span class="badge bg-danger">Failed</span>`
                        }
                    </div>
                    <button class="collapse-btn" type="button" data-bs-toggle="collapse" data-bs-target="#item-${index}" aria-expanded="false">
                        <i class="fas fa-chevron-down"></i>
                    </button>
                </div>
                <div class="collapse" id="item-${index}">
                    <div class="batch-content">
                        ${result.success ? createSuccessfulItemContent(result, index) : createFailedItemContent(result)}
                    </div>
                </div>
            `;
            return item;
        }

        function createSuccessfulItemContent(result, index) {
            return `
                <!-- Statistics -->
                <div class="stats-grid mb-3">
                    <div class="stat-card">
                        <div class="stat-value text-primary">${result.hole_ratio}</div>
                        <div class="stat-label">${t('holeRatio')}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value text-success">${result.statistics.leaf_area_pixels.toLocaleString()}</div>
                        <div class="stat-label">${t('leafArea')}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value text-danger">${result.statistics.hole_area_pixels.toLocaleString()}</div>
                        <div class="stat-label">${t('holeArea')}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value text-warning">${result.statistics.hole_count}</div>
                        <div class="stat-label">${t('holeCount')}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value text-info">${result.statistics.leaf_length_pixels ? result.statistics.leaf_length_pixels.toFixed(1) + ' px' : '-'}</div>
                        <div class="stat-label">${t('leafLength')}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value text-info">${result.statistics.leaf_width_pixels ? result.statistics.leaf_width_pixels.toFixed(1) + ' px' : '-'}</div>
                        <div class="stat-label">${t('leafWidth')}</div>
                    </div>
                    ${result.statistics.reference_detected ? `
                        <div class="stat-card">
                            <div class="stat-value text-success">${result.statistics.leaf_area_cm2.toFixed(2)}</div>
                            <div class="stat-label">${t('leafAreaCm2')}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value text-danger">${result.statistics.hole_area_cm2.toFixed(2)}</div>
                            <div class="stat-label">${t('holeAreaCm2')}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value text-info">${result.statistics.leaf_length_cm ? result.statistics.leaf_length_cm.toFixed(2) + ' cm' : '-'}</div>
                            <div class="stat-label">${t('leafLengthCm')}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value text-info">${result.statistics.leaf_width_cm ? result.statistics.leaf_width_cm.toFixed(2) + ' cm' : '-'}</div>
                            <div class="stat-label">${t('leafWidthCm')}</div>
                        </div>
                    ` : ''}
                </div>

                ${result.statistics.reference_detected ? `
                    <div class="alert alert-info mb-3">
                        <i class="fas fa-ruler me-2"></i>
                        ${t('referenceDetected')} - ${result.statistics.pixels_per_cm.toFixed(1)} ${t('pixelsPerCm')}
                    </div>
                ` : ''}

                <!-- Action Button -->
                <div class="text-center mb-3">
                    <button class="btn btn-warning btn-sm" onclick="editBatchItem(${index})">
                        <i class="fas fa-edit me-2"></i>${t('manualEdit')}
                    </button>
                </div>

                <!-- Processing Images -->
                ${result.images ? `
                    <div class="image-grid">
                        <div class="image-card">
                            <img src="${result.images.original}" alt="Original">
                            <div class="card-body">
                                <h6 class="card-title">${t('originalImage')}</h6>
                            </div>
                        </div>
                        <div class="image-card">
                            <img src="${result.images.enhanced}" alt="Enhanced">
                            <div class="card-body">
                                <h6 class="card-title">${t('enhancedImage')}</h6>
                            </div>
                        </div>
                        <div class="image-card">
                            <img src="${result.images.leaf_mask}" alt="Leaf Mask">
                            <div class="card-body">
                                <h6 class="card-title">${t('leafSegmentation')}</h6>
                            </div>
                        </div>
                        <div class="image-card">
                            <img src="${result.images.holes}" alt="Holes">
                            <div class="card-body">
                                <h6 class="card-title">${t('detectedHoles')}</h6>
                            </div>
                        </div>
                        <div class="image-card">
                            <img src="${result.images.result}" alt="Result">
                            <div class="card-body">
                                <h6 class="card-title">${t('finalResult')}</h6>
                            </div>
                        </div>
                    </div>
                ` : `
                    <div class="text-center">
                        <p class="text-muted">${t('processImagesPending')}</p>
                        <small class="text-muted">${t('processImagesNote')}</small>
                    </div>
                `}
            `;
        }

        function createFailedItemContent(result) {
            return `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    ${result.error || t('processingError')}
                </div>
            `;
        }

        function editBatchItem(index) {
            const item = batchResults.results[index];
            if (item && item.success && item.images) {
                showManualEdit(item);
            } else {
                alert(t('batchEditPlaceholder'));
            }
        }

        function exportBatchResults() {
            if (!batchResults) {
                alert('No batch results to export');
                return;
            }
            
            fetch('/export_batch_results', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(batchResults)
            })
            .then(response => {
                if (response.ok) {
                    return response.blob();
                } else {
                    throw new Error('Export failed');
                }
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'leaf_hole_detection_results.csv';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            })
            .catch(error => {
                alert('Export failed: ' + error.message);
            });
        }
    </script>
</body>
</html>