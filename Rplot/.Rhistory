set_names(data_col_names) %>%
mutate(Group = .x)
})
cat("â„¹ï¸ æ¤ç‰©æ€§çŠ¶æ•°æ®å·²æˆåŠŸè¯»å–å¹¶æ•´åˆã€‚\n")
# 3.2 æ¸…æ´—æ¤ç‰©æ€§çŠ¶æ•°æ®
trait_cols <- c("Leaf_Area_cm2", "Leaf_Length_cm", "Leaf_Width_cm", "Leaf_Dry_Mass_g", "SLA")
full_data <- full_data %>%
mutate(across(all_of(trait_cols), as.numeric)) %>%
mutate(Leaf_Dry_Mass_g = na_if(Leaf_Dry_Mass_g, 0)) %>%
mutate(Position = factor(case_when(
str_detect(Group, "-1$") ~ "å¡åº• (Slope Bottom)",
str_detect(Group, "-2$") ~ "å¡é¡¶ (Slope Top)"
), levels = c("å¡åº• (Slope Bottom)", "å¡é¡¶ (Slope Top)")))
# 3.3 ç¡¬ç¼–ç ç¯å¢ƒå› å­æ•°æ®
env_data <- tibble(
Group = c("1-1", "2-1", "3-1", "1-2", "2-2", "3-2"),
Position = rep(c("å¡åº• (Slope Bottom)", "å¡é¡¶ (Slope Top)"), each = 3),
Altitude = c(339, 344, 340, 366, 358, 354), Temperature = c(29.6, 30.5, 30.8, 28.5, 31.4, 32),
Humidity = c(75.7, 68.5, 73.8, 86.3, 71.5, 68.8), Illumination = c(0.44, 0.46, 0.47, 0.54, 0.61, 0.47),
Soil_pH = c(5.93, 5.71, 5.94, 6.14, 6, 6.11)
)
cat("âœ… æ•°æ®é¢„å¤„ç†å®Œæˆã€‚\n")
# 3.4 åˆ›å»ºå›¾ç‰‡ä¿å­˜ç›®å½•
if (!dir.exists("plots")) dir.create("plots")
# -------------------------------------------------------------------
# åˆ†æä¸€: å¾®ç¯å¢ƒå·®å¼‚åˆ†æï¼ˆæ”¹ä¸ºåˆ†åˆ«è¾“å‡ºäº”å¼ å›¾ï¼‰
# -------------------------------------------------------------------
cat("\n--- æ­£åœ¨æ‰§è¡Œåˆ†æä¸€: å¾®ç¯å¢ƒå·®å¼‚åˆ†æ ---\n")
env_factors_long <- env_data %>% pivot_longer(cols = -c(Group, Position), names_to = "Factor", values_to = "Value")
env_factors <- unique(env_factors_long$Factor)
plots_env <- map(env_factors, ~{
df_plot <- env_factors_long %>% filter(Factor == .x, is.finite(Value))
p <- ggplot(df_plot, aes(x = Position, y = Value, fill = Position)) +
geom_boxplot(alpha = 0.8, width = 0.6, outlier.shape = NA) +
geom_jitter(width = 0.1, alpha = 0.45, size = 1.4) +
stat_summary(fun = median, geom = "point", size = 2, color = "black") +
stat_compare_means(method = "t.test", label = "p.signif", symnum.args = signif_symbols, label.y.npc = 0.95, size = 5.5) +
scale_fill_manual(values = color_palette) +
scale_y_continuous(expand = expansion(mult = c(0.06, 0.18))) +
coord_cartesian(clip = "off") +
labs(title = paste0("å¾®ç¯å¢ƒå› å­å·®å¼‚æ¯”è¾ƒ - ", .x), x = NULL, y = .x) +
theme(
legend.position = "none",
axis.text.x = element_text(angle = 30, hjust = 1),
plot.margin = margin(12, 18, 12, 18)
)
ggsave(filename = paste0("plots/1_Environment_Comparison_", .x, ".png"), plot = p, width = 6, height = 6, dpi = 300)
return(p)
})
cat("âœ… å›¾ 1: 5å¼ å¾®ç¯å¢ƒå› å­å·®å¼‚æ¯”è¾ƒå›¾å·²åˆ†åˆ«ç”Ÿæˆã€‚\n")
# -------------------------------------------------------------------
# åˆ†æäºŒ: å•ä¸ªæ€§çŠ¶æ¯”è¾ƒ
# -------------------------------------------------------------------
cat("\n--- æ­£åœ¨æ‰§è¡Œåˆ†æäºŒ: å•ä¸ªæ€§çŠ¶æ¯”è¾ƒ ---\n")
# ä½¿ç”¨ purrr::map æ¥å¾ªç¯ç»˜å›¾ï¼Œä»£ç æ›´ç®€æ´
plots_trait_comparison <- map(trait_cols, ~{
plot_data <- full_data %>% filter(is.finite(.data[[.x]]))
p <- ggplot(plot_data, aes(x = Position, y = .data[[.x]], fill = Position)) +
geom_violin(trim = FALSE, alpha = 0.25, width = 0.9, color = NA) +
geom_boxplot(width = 0.18, fill = "white", outlier.shape = NA) +
geom_jitter(width = 0.12, alpha = 0.45, size = 1.6) +
stat_summary(fun = median, geom = "point", size = 2, color = "black") +
stat_compare_means(method = "wilcox.test", label = "p.signif", symnum.args = signif_symbols,
label.y.npc = 0.95, size = 5.5) +
scale_fill_manual(values = color_palette, name = "åœ°å½¢ä½ç½®") +
scale_y_continuous(expand = expansion(mult = c(0.05, 0.15))) +
labs(title = .x, x = NULL, y = "æ€§çŠ¶å€¼",
caption = "Wilcoxonæ£€éªŒ: ns:p>0.1, .:pâ‰¤0.1, *:pâ‰¤0.05")
ggsave(filename = paste0("plots/2_Trait_Comparison_", .x, ".png"), plot = p, width = 6, height = 6, dpi = 300)
return(p)
})
cat("âœ… å›¾ 2: 5ä¸ªå•æ€§çŠ¶æ¯”è¾ƒå›¾å·²åˆ†åˆ«ç”Ÿæˆã€‚\n")
# -------------------------------------------------------------------
# åˆ†æä¸‰: ç‰©ç§å±‚é¢å“åº”
# -------------------------------------------------------------------
cat("\n--- æ­£åœ¨æ‰§è¡Œåˆ†æä¸‰: ç‰©ç§å±‚é¢å“åº” ---\n")
common_species <- full_data %>% count(Name_CH, Position) %>%
pivot_wider(names_from = Position, values_from = n, values_fill = 0) %>%
filter(if_all(everything(), ~ . >= 3)) %>% pull(Name_CH)
if (length(common_species) > 0) {
species_data <- full_data %>% filter(Name_CH %in% common_species)
key_traits_species <- c("SLA", "Leaf_Dry_Mass_g")
plots_species <- map(key_traits_species, ~{
plot_df <- species_data %>% filter(is.finite(.data[[.x]]))
valid_species <- plot_df %>%
group_by(Name_CH) %>%
summarise(n_groups = n_distinct(Position), .groups = "drop") %>%
filter(n_groups == 2) %>% pull(Name_CH)
plot_df <- plot_df %>% filter(Name_CH %in% valid_species)
if (nrow(plot_df) == 0) return(NULL)
p <- ggplot(plot_df, aes(x = Position, y = .data[[.x]], fill = Position)) +
geom_boxplot(width = 0.6, outlier.shape = NA) +
geom_jitter(width = 0.1, alpha = 0.4, size = 1.3) +
stat_summary(fun = median, geom = "point", size = 1.8, color = "black") +
stat_compare_means(method = "wilcox.test", label = "p.signif", symnum.args = signif_symbols, label.y.npc = 0.92) +
facet_wrap(~ Name_CH, scales = "free_y") +
scale_fill_manual(values = color_palette) +
scale_y_continuous(expand = expansion(mult = c(0.05, 0.15))) +
labs(title = paste("å…³é”®ç‰©ç§çš„", .x, "å“åº”"), x = NULL, y = .x) +
theme(legend.position = "none", axis.text.x = element_text(angle = 30, hjust = 1))
plot_width <- max(6, 3 + 3 * length(unique(plot_df$Name_CH)))
ggsave(filename = paste0("plots/3_Species_Response_", .x, ".png"),
plot = p, width = plot_width, height = 6, dpi = 300)
})
cat("âœ… å›¾ 3: å…³é”®ç‰©ç§å“åº”åˆ†æå›¾å·²ç”Ÿæˆã€‚\n")
} else {
cat("â„¹ï¸ æœªæ‰¾åˆ°è¶³å¤Ÿæ ·æœ¬çš„å…±åŒç‰©ç§ï¼Œè·³è¿‡æ­¤åˆ†æã€‚\n")
}
cat("\nğŸ‰ ===================== æ‰€æœ‰åˆ†æå…¨éƒ¨ç»“æŸ ===================== ğŸ‰\n")
cat("æ‰€æœ‰ç»“æœå›¾è¡¨å·²ä¿å­˜åœ¨ 'plots' æ–‡ä»¶å¤¹ä¸­ã€‚\n")
# -------------------------------------------------------------------
# æ­¥éª¤ 1: ç¯å¢ƒå‡†å¤‡
# -------------------------------------------------------------------
# å®‰è£…å’ŒåŠ è½½æ‰€æœ‰éœ€è¦çš„åŒ…
options(repos = c(CRAN = "https://cloud.r-project.org"))
packages_to_install <- c("readxl", "dplyr", "tidyr", "ggplot2", "ggpubr", "purrr", "stringr")
new_packages <- packages_to_install[!(packages_to_install %in% installed.packages()[,"Package"])]
if(length(new_packages)) install.packages(new_packages)
suppressPackageStartupMessages({
library(readxl)
library(dplyr)
library(tidyr)
library(ggplot2)
library(ggpubr)
library(purrr)
library(stringr)
})
cat("âœ… æ‰€æœ‰éœ€è¦çš„ R åŒ…å·²æˆåŠŸåŠ è½½ã€‚\n")
# -------------------------------------------------------------------
# æ­¥éª¤ 2: å…¨å±€ç¾å­¦è®¾å®š (ç»Ÿä¸€å›¾è¡¨é£æ ¼)
# -------------------------------------------------------------------
# è®¾å®šé¢œè‰²æ–¹æ¡ˆ
color_palette <- c("å¡åº• (Slope Bottom)" = "#3B82F6", "å¡é¡¶ (Slope Top)" = "#F97316")
# è®¾å®šç»Ÿä¸€çš„ ggplot2 ä¸»é¢˜
theme_set(
theme_classic(base_size = 14) +
theme(
plot.title = element_text(hjust = 0.5, face = "bold", size = 18),
plot.subtitle = element_text(hjust = 0.5, size = 12, color = "gray30"),
plot.caption = element_text(hjust = 1, size = 9, color = "gray50"),
legend.position = "top",
axis.text = element_text(color = "black"),
strip.background = element_rect(fill = "gray90", color = "gray90"),
strip.text = element_text(face = "bold", color = "black")
)
)
# è®¾å®šæ˜¾è‘—æ€§ç¬¦å· (é‡‡ç”¨æ”¾å®½çš„på€¼æ ‡å‡†)
signif_symbols <- list(cutpoints = c(0, 0.001, 0.01, 0.05, 0.1, 1),
symbols = c("***", "**", "*", ".", "ns"))
cat("ğŸ¨ å…¨å±€ç¾å­¦é£æ ¼å·²è®¾å®šã€‚\n")
# -------------------------------------------------------------------
# æ­¥éª¤ 3: æ•°æ®å¯¼å…¥ä¸å¤„ç†
# -------------------------------------------------------------------
# 3.1 ä» Excel è¯»å–æ¤ç‰©æ€§çŠ¶æ•°æ®
excel_file <- "data.xlsx"
if (!file.exists(excel_file)) { stop("âŒ é”™è¯¯: 'data.xlsx' æ–‡ä»¶æœªåœ¨å½“å‰å·¥ä½œç›®å½•ä¸­æ‰¾åˆ°ã€‚") }
sheet_names <- c("1-1", "1-2", "2-1", "2-2", "3-1", "3-2")
data_col_names <- c("ID", "Name_CH", "Name_LAT", "Family", "Genus", "Leaf_Area_cm2",
"Leaf_Length_cm", "Leaf_Width_cm", "Leaf_Dry_Mass_g", "SLA")
full_data <- map_dfr(sheet_names, ~{
read_excel(excel_file, sheet = .x, col_names = FALSE, skip = 1) %>%
select(1:10) %>%
set_names(data_col_names) %>%
mutate(Group = .x)
})
cat("â„¹ï¸ æ¤ç‰©æ€§çŠ¶æ•°æ®å·²æˆåŠŸè¯»å–å¹¶æ•´åˆã€‚\n")
# 3.2 æ¸…æ´—æ¤ç‰©æ€§çŠ¶æ•°æ®
trait_cols <- c("Leaf_Area_cm2", "Leaf_Length_cm", "Leaf_Width_cm", "Leaf_Dry_Mass_g", "SLA")
full_data <- full_data %>%
mutate(across(all_of(trait_cols), as.numeric)) %>%
mutate(Leaf_Dry_Mass_g = na_if(Leaf_Dry_Mass_g, 0)) %>%
mutate(Position = factor(case_when(
str_detect(Group, "-1$") ~ "å¡åº• (Slope Bottom)",
str_detect(Group, "-2$") ~ "å¡é¡¶ (Slope Top)"
), levels = c("å¡åº• (Slope Bottom)", "å¡é¡¶ (Slope Top)")))
# 3.3 ç¡¬ç¼–ç ç¯å¢ƒå› å­æ•°æ®
env_data <- tibble(
Group = c("1-1", "2-1", "3-1", "1-2", "2-2", "3-2"),
Position = rep(c("å¡åº• (Slope Bottom)", "å¡é¡¶ (Slope Top)"), each = 3),
Altitude = c(339, 344, 340, 366, 358, 354), Temperature = c(29.6, 30.5, 30.8, 28.5, 31.4, 32),
Humidity = c(75.7, 68.5, 73.8, 86.3, 71.5, 68.8), Illumination = c(0.44, 0.46, 0.47, 0.54, 0.61, 0.47),
Soil_pH = c(5.93, 5.71, 5.94, 6.14, 6, 6.11)
)
cat("âœ… æ•°æ®é¢„å¤„ç†å®Œæˆã€‚\n")
# 3.4 åˆ›å»ºå›¾ç‰‡ä¿å­˜ç›®å½•
if (!dir.exists("plots")) dir.create("plots")
# ===================================================================
# åˆ†ææµç¨‹å¼€å§‹
# ===================================================================
# -------------------------------------------------------------------
# åˆ†æä¸€: å¾®ç¯å¢ƒå·®å¼‚åˆ†æï¼ˆæ”¹ä¸ºåˆ†åˆ«è¾“å‡ºäº”å¼ å›¾ï¼‰
# -------------------------------------------------------------------
cat("\n--- æ­£åœ¨æ‰§è¡Œåˆ†æä¸€: å¾®ç¯å¢ƒå·®å¼‚åˆ†æ ---\n")
env_factors_long <- env_data %>% pivot_longer(cols = -c(Group, Position), names_to = "Factor", values_to = "Value")
env_factors <- unique(env_factors_long$Factor)
plots_env <- map(env_factors, ~{
df_plot <- env_factors_long %>% filter(Factor == .x, is.finite(Value))
p <- ggplot(df_plot, aes(x = Position, y = Value, fill = Position)) +
geom_boxplot(alpha = 0.8, width = 0.6, outlier.shape = NA) +
geom_jitter(width = 0.1, alpha = 0.45, size = 1.4) +
stat_summary(fun = median, geom = "point", size = 2, color = "black") +
stat_compare_means(method = "t.test", label = "p.signif", symnum.args = signif_symbols, label.y.npc = 0.95, size = 5.5) +
scale_fill_manual(values = color_palette) +
scale_y_continuous(expand = expansion(mult = c(0.06, 0.18))) +
coord_cartesian(clip = "off") +
labs(title = paste0("å¾®ç¯å¢ƒå› å­å·®å¼‚æ¯”è¾ƒ - ", .x), x = NULL, y = .x) +
theme(
legend.position = "none",
axis.text.x = element_text(angle = 30, hjust = 1),
plot.margin = margin(12, 18, 12, 18)
)
ggsave(filename = paste0("plots/1_Environment_Comparison_", .x, ".png"), plot = p, width = 6, height = 6, dpi = 300)
return(p)
})
cat("âœ… å›¾ 1: 5å¼ å¾®ç¯å¢ƒå› å­å·®å¼‚æ¯”è¾ƒå›¾å·²åˆ†åˆ«ç”Ÿæˆã€‚\n")
# -------------------------------------------------------------------
# åˆ†æäºŒ: å•ä¸ªæ€§çŠ¶æ¯”è¾ƒ
# -------------------------------------------------------------------
cat("\n--- æ­£åœ¨æ‰§è¡Œåˆ†æäºŒ: å•ä¸ªæ€§çŠ¶æ¯”è¾ƒ ---\n")
# ä½¿ç”¨ purrr::map æ¥å¾ªç¯ç»˜å›¾ï¼Œä»£ç æ›´ç®€æ´
plots_trait_comparison <- map(trait_cols, ~{
plot_data <- full_data %>% filter(is.finite(.data[[.x]]))
p <- ggplot(plot_data, aes(x = Position, y = .data[[.x]], fill = Position)) +
geom_violin(trim = FALSE, alpha = 0.25, width = 0.9, color = NA) +
geom_boxplot(width = 0.18, fill = "white", outlier.shape = NA) +
geom_jitter(width = 0.12, alpha = 0.45, size = 1.6) +
stat_summary(fun = median, geom = "point", size = 2, color = "black") +
stat_compare_means(method = "wilcox.test", label = "p.signif", symnum.args = signif_symbols,
label.y.npc = 0.95, size = 5.5) +
scale_fill_manual(values = color_palette, name = "åœ°å½¢ä½ç½®") +
scale_y_continuous(expand = expansion(mult = c(0.05, 0.15))) +
labs(title = .x, x = NULL, y = "æ€§çŠ¶å€¼",
caption = "Wilcoxonæ£€éªŒ: ns:p>0.1, .:pâ‰¤0.1, *:pâ‰¤0.05")
ggsave(filename = paste0("plots/2_Trait_Comparison_", .x, ".png"), plot = p, width = 6, height = 6, dpi = 300)
return(p)
})
cat("âœ… å›¾ 2: 5ä¸ªå•æ€§çŠ¶æ¯”è¾ƒå›¾å·²åˆ†åˆ«ç”Ÿæˆã€‚\n")
# -------------------------------------------------------------------
# åˆ†æä¸‰: ç‰©ç§å±‚é¢å“åº”
# -------------------------------------------------------------------
cat("\n--- æ­£åœ¨æ‰§è¡Œåˆ†æä¸‰: ç‰©ç§å±‚é¢å“åº” ---\n")
common_species <- full_data %>% count(Name_CH, Position) %>%
pivot_wider(names_from = Position, values_from = n, values_fill = 0) %>%
filter(if_all(everything(), ~ . >= 3)) %>% pull(Name_CH)
if (length(common_species) > 0) {
species_data <- full_data %>% filter(Name_CH %in% common_species)
key_traits_species <- c("SLA", "Leaf_Dry_Mass_g")
plots_species <- map(key_traits_species, ~{
plot_df <- species_data %>% filter(is.finite(.data[[.x]]))
valid_species <- plot_df %>%
group_by(Name_CH) %>%
summarise(n_groups = n_distinct(Position), .groups = "drop") %>%
filter(n_groups == 2) %>% pull(Name_CH)
plot_df <- plot_df %>% filter(Name_CH %in% valid_species)
if (nrow(plot_df) == 0) return(NULL)
p <- ggplot(plot_df, aes(x = Position, y = .data[[.x]], fill = Position)) +
geom_boxplot(width = 0.6, outlier.shape = NA) +
geom_jitter(width = 0.1, alpha = 0.4, size = 1.3) +
stat_summary(fun = median, geom = "point", size = 1.8, color = "black") +
stat_compare_means(method = "wilcox.test", label = "p.signif", symnum.args = signif_symbols, label.y.npc = 0.92) +
facet_wrap(~ Name_CH, scales = "free_y") +
scale_fill_manual(values = color_palette) +
scale_y_continuous(expand = expansion(mult = c(0.05, 0.15))) +
labs(title = paste("å…³é”®ç‰©ç§çš„", .x, "å“åº”"), x = NULL, y = .x) +
theme(legend.position = "none", axis.text.x = element_text(angle = 30, hjust = 1))
plot_width <- max(6, 3 + 3 * length(unique(plot_df$Name_CH)))
ggsave(filename = paste0("plots/3_Species_Response_", .x, ".png"),
plot = p, width = plot_width, height = 6, dpi = 300)
})
cat("âœ… å›¾ 3: å…³é”®ç‰©ç§å“åº”åˆ†æå›¾å·²ç”Ÿæˆã€‚\n")
} else {
cat("â„¹ï¸ æœªæ‰¾åˆ°è¶³å¤Ÿæ ·æœ¬çš„å…±åŒç‰©ç§ï¼Œè·³è¿‡æ­¤åˆ†æã€‚\n")
}
cat("\nğŸ‰ ===================== æ‰€æœ‰åˆ†æå…¨éƒ¨ç»“æŸ ===================== ğŸ‰\n")
cat("æ‰€æœ‰ç»“æœå›¾è¡¨å·²ä¿å­˜åœ¨ 'plots' æ–‡ä»¶å¤¹ä¸­ã€‚\n")
# -------------------------------------------------------------------
# æ­¥éª¤ 1: ç¯å¢ƒå‡†å¤‡
# -------------------------------------------------------------------
# å®‰è£…å’ŒåŠ è½½æ‰€æœ‰éœ€è¦çš„åŒ…
options(repos = c(CRAN = "https://cloud.r-project.org"))
packages_to_install <- c("readxl", "dplyr", "tidyr", "ggplot2", "ggpubr", "purrr", "stringr")
new_packages <- packages_to_install[!(packages_to_install %in% installed.packages()[,"Package"])]
if(length(new_packages)) install.packages(new_packages)
suppressPackageStartupMessages({
library(readxl)
library(dplyr)
library(tidyr)
library(ggplot2)
library(ggpubr)
library(purrr)
library(stringr)
})
cat("âœ… æ‰€æœ‰éœ€è¦çš„ R åŒ…å·²æˆåŠŸåŠ è½½ã€‚\n")
# -------------------------------------------------------------------
# æ­¥éª¤ 2: å…¨å±€ç¾å­¦è®¾å®š (ç»Ÿä¸€å›¾è¡¨é£æ ¼)
# -------------------------------------------------------------------
# è®¾å®šé¢œè‰²æ–¹æ¡ˆ
color_palette <- c("å¡åº• (Slope Bottom)" = "#3B82F6", "å¡é¡¶ (Slope Top)" = "#F97316")
# è®¾å®šç»Ÿä¸€çš„ ggplot2 ä¸»é¢˜
theme_set(
theme_classic(base_size = 14) +
theme(
plot.title = element_text(hjust = 0.5, face = "bold", size = 18),
plot.subtitle = element_text(hjust = 0.5, size = 12, color = "gray30"),
plot.caption = element_text(hjust = 1, size = 9, color = "gray50"),
legend.position = "top",
axis.text = element_text(color = "black"),
strip.background = element_rect(fill = "gray90", color = "gray90"),
strip.text = element_text(face = "bold", color = "black")
)
)
# è®¾å®šæ˜¾è‘—æ€§ç¬¦å· (é‡‡ç”¨æ”¾å®½çš„på€¼æ ‡å‡†)
signif_symbols <- list(cutpoints = c(0, 0.001, 0.01, 0.05, 0.1, 1),
symbols = c("***", "**", "*", ".", "ns"))
cat("ğŸ¨ å…¨å±€ç¾å­¦é£æ ¼å·²è®¾å®šã€‚\n")
# -------------------------------------------------------------------
# æ­¥éª¤ 3: æ•°æ®å¯¼å…¥ä¸å¤„ç†
# -------------------------------------------------------------------
# 3.1 ä» Excel è¯»å–æ¤ç‰©æ€§çŠ¶æ•°æ®
excel_file <- "data.xlsx"
if (!file.exists(excel_file)) { stop("âŒ é”™è¯¯: 'data.xlsx' æ–‡ä»¶æœªåœ¨å½“å‰å·¥ä½œç›®å½•ä¸­æ‰¾åˆ°ã€‚") }
sheet_names <- c("1-1", "1-2", "2-1", "2-2", "3-1", "3-2")
data_col_names <- c("ID", "Name_CH", "Name_LAT", "Family", "Genus", "Leaf_Area_cm2",
"Leaf_Length_cm", "Leaf_Width_cm", "Leaf_Dry_Mass_g", "SLA")
full_data <- map_dfr(sheet_names, ~{
read_excel(excel_file, sheet = .x, col_names = FALSE, skip = 1) %>%
select(1:10) %>%
set_names(data_col_names) %>%
mutate(Group = .x)
})
cat("â„¹ï¸ æ¤ç‰©æ€§çŠ¶æ•°æ®å·²æˆåŠŸè¯»å–å¹¶æ•´åˆã€‚\n")
# 3.2 æ¸…æ´—æ¤ç‰©æ€§çŠ¶æ•°æ®
trait_cols <- c("Leaf_Area_cm2", "Leaf_Length_cm", "Leaf_Width_cm", "Leaf_Dry_Mass_g", "SLA")
full_data <- full_data %>%
mutate(across(all_of(trait_cols), as.numeric)) %>%
mutate(Leaf_Dry_Mass_g = na_if(Leaf_Dry_Mass_g, 0)) %>%
mutate(Position = factor(case_when(
str_detect(Group, "-1$") ~ "å¡åº• (Slope Bottom)",
str_detect(Group, "-2$") ~ "å¡é¡¶ (Slope Top)"
), levels = c("å¡åº• (Slope Bottom)", "å¡é¡¶ (Slope Top)")))
# 3.3 ç¡¬ç¼–ç ç¯å¢ƒå› å­æ•°æ®
env_data <- tibble(
Group = c("1-1", "2-1", "3-1", "1-2", "2-2", "3-2"),
Position = rep(c("å¡åº• (Slope Bottom)", "å¡é¡¶ (Slope Top)"), each = 3),
Altitude = c(342.5, 336, 397, 362, 356.5, 402), Temperature = c(30.05, 30.9, 31, 31, 31.85, 31.6),
Humidity = c(72.1, 72.9, 73.6, 78.9, 67.7, 76.2), Illumination = c(0.45, 0.63, 0.805, 0.575, 0.655, 0.94),
Soil_pH = c(5.86, 6.457, 6.083, 6.583, 6.34, 6.36)
)
cat("âœ… æ•°æ®é¢„å¤„ç†å®Œæˆã€‚\n")
# 3.4 åˆ›å»ºå›¾ç‰‡ä¿å­˜ç›®å½•
if (!dir.exists("plots")) dir.create("plots")
# -------------------------------------------------------------------
# åˆ†æä¸€: å¾®ç¯å¢ƒå·®å¼‚åˆ†æï¼ˆæ”¹ä¸ºåˆ†åˆ«è¾“å‡ºäº”å¼ å›¾ï¼‰
# -------------------------------------------------------------------
cat("\n--- æ­£åœ¨æ‰§è¡Œåˆ†æä¸€: å¾®ç¯å¢ƒå·®å¼‚åˆ†æ ---\n")
env_factors_long <- env_data %>% pivot_longer(cols = -c(Group, Position), names_to = "Factor", values_to = "Value")
env_factors <- unique(env_factors_long$Factor)
plots_env <- map(env_factors, ~{
df_plot <- env_factors_long %>% filter(Factor == .x, is.finite(Value))
p <- ggplot(df_plot, aes(x = Position, y = Value, fill = Position)) +
geom_boxplot(alpha = 0.8, width = 0.6, outlier.shape = NA) +
geom_jitter(width = 0.1, alpha = 0.45, size = 1.4) +
stat_summary(fun = median, geom = "point", size = 2, color = "black") +
stat_compare_means(method = "t.test", label = "p.signif", symnum.args = signif_symbols, label.y.npc = 0.95, size = 5.5) +
scale_fill_manual(values = color_palette) +
scale_y_continuous(expand = expansion(mult = c(0.06, 0.18))) +
coord_cartesian(clip = "off") +
labs(title = paste0("å¾®ç¯å¢ƒå› å­å·®å¼‚æ¯”è¾ƒ - ", .x), x = NULL, y = .x) +
theme(
legend.position = "none",
axis.text.x = element_text(angle = 30, hjust = 1),
plot.margin = margin(12, 18, 12, 18)
)
ggsave(filename = paste0("plots/1_Environment_Comparison_", .x, ".png"), plot = p, width = 6, height = 6, dpi = 300)
return(p)
})
cat("âœ… å›¾ 1: 5å¼ å¾®ç¯å¢ƒå› å­å·®å¼‚æ¯”è¾ƒå›¾å·²åˆ†åˆ«ç”Ÿæˆã€‚\n")
# -------------------------------------------------------------------
# åˆ†æäºŒ: å•ä¸ªæ€§çŠ¶æ¯”è¾ƒ
# -------------------------------------------------------------------
cat("\n--- æ­£åœ¨æ‰§è¡Œåˆ†æäºŒ: å•ä¸ªæ€§çŠ¶æ¯”è¾ƒ ---\n")
# ä½¿ç”¨ purrr::map æ¥å¾ªç¯ç»˜å›¾ï¼Œä»£ç æ›´ç®€æ´
plots_trait_comparison <- map(trait_cols, ~{
plot_data <- full_data %>% filter(is.finite(.data[[.x]]))
p <- ggplot(plot_data, aes(x = Position, y = .data[[.x]], fill = Position)) +
geom_violin(trim = FALSE, alpha = 0.25, width = 0.9, color = NA) +
geom_boxplot(width = 0.18, fill = "white", outlier.shape = NA) +
geom_jitter(width = 0.12, alpha = 0.45, size = 1.6) +
stat_summary(fun = median, geom = "point", size = 2, color = "black") +
stat_compare_means(method = "wilcox.test", label = "p.signif", symnum.args = signif_symbols,
label.y.npc = 0.95, size = 5.5) +
scale_fill_manual(values = color_palette, name = "åœ°å½¢ä½ç½®") +
scale_y_continuous(expand = expansion(mult = c(0.05, 0.15))) +
labs(title = .x, x = NULL, y = "æ€§çŠ¶å€¼",
caption = "Wilcoxonæ£€éªŒ: ns:p>0.1, .:pâ‰¤0.1, *:pâ‰¤0.05")
ggsave(filename = paste0("plots/2_Trait_Comparison_", .x, ".png"), plot = p, width = 6, height = 6, dpi = 300)
return(p)
})
cat("âœ… å›¾ 2: 5ä¸ªå•æ€§çŠ¶æ¯”è¾ƒå›¾å·²åˆ†åˆ«ç”Ÿæˆã€‚\n")
# -------------------------------------------------------------------
# åˆ†æä¸‰: ç‰©ç§å±‚é¢å“åº”
# -------------------------------------------------------------------
cat("\n--- æ­£åœ¨æ‰§è¡Œåˆ†æä¸‰: ç‰©ç§å±‚é¢å“åº” ---\n")
common_species <- full_data %>% count(Name_CH, Position) %>%
pivot_wider(names_from = Position, values_from = n, values_fill = 0) %>%
filter(if_all(everything(), ~ . >= 3)) %>% pull(Name_CH)
if (length(common_species) > 0) {
species_data <- full_data %>% filter(Name_CH %in% common_species)
key_traits_species <- c("SLA", "Leaf_Dry_Mass_g")
plots_species <- map(key_traits_species, ~{
plot_df <- species_data %>% filter(is.finite(.data[[.x]]))
valid_species <- plot_df %>%
group_by(Name_CH) %>%
summarise(n_groups = n_distinct(Position), .groups = "drop") %>%
filter(n_groups == 2) %>% pull(Name_CH)
plot_df <- plot_df %>% filter(Name_CH %in% valid_species)
if (nrow(plot_df) == 0) return(NULL)
p <- ggplot(plot_df, aes(x = Position, y = .data[[.x]], fill = Position)) +
geom_boxplot(width = 0.6, outlier.shape = NA) +
geom_jitter(width = 0.1, alpha = 0.4, size = 1.3) +
stat_summary(fun = median, geom = "point", size = 1.8, color = "black") +
stat_compare_means(method = "wilcox.test", label = "p.signif", symnum.args = signif_symbols, label.y.npc = 0.92) +
facet_wrap(~ Name_CH, scales = "free_y") +
scale_fill_manual(values = color_palette) +
scale_y_continuous(expand = expansion(mult = c(0.05, 0.15))) +
labs(title = paste("å…³é”®ç‰©ç§çš„", .x, "å“åº”"), x = NULL, y = .x) +
theme(legend.position = "none", axis.text.x = element_text(angle = 30, hjust = 1))
plot_width <- max(6, 3 + 3 * length(unique(plot_df$Name_CH)))
ggsave(filename = paste0("plots/3_Species_Response_", .x, ".png"),
plot = p, width = plot_width, height = 6, dpi = 300)
})
cat("âœ… å›¾ 3: å…³é”®ç‰©ç§å“åº”åˆ†æå›¾å·²ç”Ÿæˆã€‚\n")
} else {
cat("â„¹ï¸ æœªæ‰¾åˆ°è¶³å¤Ÿæ ·æœ¬çš„å…±åŒç‰©ç§ï¼Œè·³è¿‡æ­¤åˆ†æã€‚\n")
}
cat("\nğŸ‰ ===================== æ‰€æœ‰åˆ†æå…¨éƒ¨ç»“æŸ ===================== ğŸ‰\n")
cat("æ‰€æœ‰ç»“æœå›¾è¡¨å·²ä¿å­˜åœ¨ 'plots' æ–‡ä»¶å¤¹ä¸­ã€‚\n")
## -------------------------------------------------------------------
## åˆ†æå››: ç¯å¢ƒå˜é‡ Ã— æ€§çŠ¶ å•å˜é‡çº¿æ€§å›å½’ï¼ˆç»„æ°´å¹³ï¼‰
## -------------------------------------------------------------------
cat("\n--- æ­£åœ¨æ‰§è¡Œåˆ†æå››: ç¯å¢ƒå˜é‡ Ã— æ€§çŠ¶ å•å˜é‡çº¿æ€§å›å½’ ---\n")
# ç»„æ°´å¹³æ€§çŠ¶æ±‡æ€»ï¼ˆä½¿ç”¨ä¸­ä½æ•°ï¼‰
trait_group_summary <- full_data %>%
group_by(Group) %>%
summarise(across(all_of(trait_cols), ~ median(.x, na.rm = TRUE)), .groups = "drop")
# åˆå¹¶ç¯å¢ƒä¸ç»„æ€§çŠ¶
env_trait_group <- env_data %>% left_join(trait_group_summary, by = "Group")
# ç¯å¢ƒä¸æ€§çŠ¶ä¸­æ–‡æ ‡ç­¾
env_labels <- c(
Altitude = "æµ·æ‹” (m)",
Temperature = "æ¸©åº¦ (Â°C)",
Humidity = "æ¹¿åº¦ (%)",
Illumination = "ç…§åº¦",
Soil_pH = "åœŸå£¤ pH"
)
trait_labels <- c(
Leaf_Area_cm2 = "å¶é¢ç§¯ (cmÂ²)",
Leaf_Length_cm = "å¶é•¿ (cm)",
Leaf_Width_cm = "å¶å®½ (cm)",
Leaf_Dry_Mass_g = "å¶å¹²é‡ (g)",
SLA = "SLA"
)
env_vars <- names(env_labels)
lm_results <- list()
for (env_var in env_vars) {
for (trait in trait_cols) {
df <- env_trait_group %>% select(all_of(c(env_var, trait))) %>%
rename(x = all_of(env_var), y = all_of(trait)) %>%
filter(is.finite(x), is.finite(y))
if (nrow(df) >= 3) {
fit <- lm(y ~ x, data = df)
g <- broom::glance(fit)
t <- broom::tidy(fit)
p <- ggplot(df, aes(x = x, y = y)) +
geom_point(size = 2.5, alpha = 0.85, color = "#111827") +
geom_smooth(method = "lm", se = TRUE, color = "#2563EB", fill = "#93C5FD", alpha = 0.35) +
ggpubr::stat_regline_equation(label.y.npc = 0.98, size = 5) +
ggpubr::stat_cor(label.y.npc = 0.9, size = 5) +
scale_y_continuous(expand = expansion(mult = c(0.05, 0.1))) +
scale_x_continuous(expand = expansion(mult = c(0.05, 0.05))) +
labs(title = paste0(trait_labels[[trait]], " vs ", env_labels[[env_var]]),
x = env_labels[[env_var]], y = trait_labels[[trait]]) +
theme(plot.margin = margin(12, 16, 12, 16))
out_name <- paste0("plots/4_LM_", trait, "_vs_", env_var, ".png")
ggsave(out_name, plot = p, width = 6.2, height = 5.6, dpi = 300)
slope_row <- t %>% dplyr::filter(term == "x")
lm_results[[length(lm_results) + 1]] <- tibble(
Trait = trait,
EnvVar = env_var,
Intercept = t$estimate[t$term == "(Intercept)"],
Slope = slope_row$estimate,
StdErr_Slope = slope_row$std.error,
t_Slope = slope_row$statistic,
p_Slope = slope_row$p.value,
R2 = g$r.squared,
Adj_R2 = g$adj.r.squared,
F_Statistic = g$statistic,
p_Model = g$p.value,
N = nrow(df)
)
}
}
}
if (length(lm_results)) {
lm_tbl <- dplyr::bind_rows(lm_results) %>% dplyr::arrange(Trait, EnvVar)
readr::write_csv(lm_tbl, file = "plots/4_LM_Summary.csv")
cat("âœ… å›¾ 4: å•å˜é‡çº¿æ€§å›å½’å·²å®Œæˆï¼Œå›¾ä¸è¡¨å·²è¾“å‡ºã€‚\n")
} else {
cat("â„¹ï¸ å›¾ 4: æ²¡æœ‰è¶³å¤Ÿæ•°æ®è¿›è¡Œå•å˜é‡çº¿æ€§å›å½’ã€‚\n")
}
cat("\nğŸ‰ ===================== æ‰€æœ‰åˆ†æå…¨éƒ¨ç»“æŸ ===================== ğŸ‰\n")
cat("æ‰€æœ‰ç»“æœå›¾è¡¨å·²ä¿å­˜åœ¨ 'plots' æ–‡ä»¶å¤¹ä¸­ã€‚\n")
